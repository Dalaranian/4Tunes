<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/resources/css/nav.css" />
<link rel="stylesheet" href="/resources/css/globalfont.css" />
<link rel="stylesheet" href="/resources/css/community_detail.css" />
<link rel="shortcut icon" href="/resources/img/realfavicon.ico" />
<script type="text/javascript"
	src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<title>4Tunes</title>
<script>
$(document).ready(function() {
	  $("#report-comment-btn").click(function(e) {
	    e.preventDefault();
	    var commentNo = $(this).data("comment-no");

	    // AJAX 요청
	    $.ajax({
	      url: "/check/report/comment/" + commentNo,
	      type: "GET",
	      success: function(response) {
	        if (response === "reported") {
	          alert("이미 신고하셨습니다.");
	        } else {
	          if (confirm("정말 신고하시겠습니까?")) {
	            reportComment(commentNo);
	          }
	        }
	      },
	      error: function() {
	        alert("오류가 발생했습니다.");
	      }
	    });
	  });

	  // 댓글 신고 처리 함수
	  function reportComment(commentNo) {
	    $.ajax({
	      url: "/report/comment/" + commentNo,
	      type: "POST",
	      success: function(response) {
	        window.location.href = response; // 신고 후 페이지 리다이렉트
	      },
	      error: function() {
	        alert("오류가 발생했습니다.");
	      }
	    });
	  }
	});


	$(document).ready(function() {
		$('#report-btn').click(function(event) {
			event.preventDefault(); // 폼의 기본 동작인 페이지 새로고침 막기

			var confirmed = confirm("정말로 신고하시겠습니까?");
			if (confirmed) {
				var form = $('#report-form');
				var url = form.attr('action');

				$.ajax({
					type : "POST",
					url : url,
					success : function(response) {
						// 신고 성공한 경우, 알림 표시
						alert(response);
						// 상세 페이지로 리다이렉트
						window.location.href = "/community/detail/" + boardNo;
					},
					error : function(xhr, status, error) {
						if (xhr.status === 409) {
							// 중복 신고한 경우, 알림 표시
							alert(xhr.responseText);
						} else {
							// 실패한 경우, 로그인 페이지로
							alert("로그인 먼저 해주세요.");
							window.location.href = "/nav/login/";
						}
					}
				});
			} else {
				// 신고 취소한 경우, 아무 작업 없이 종료
			}
		});
	});
</script>

</head>

<body>
	<div id="nav">
		<div class="banner">
			<a href="/"><img src="/resources/img/banner.png" /></a>
		</div>
		<div id="login">
			<div>
				<a
					th:href="${session.login == null ? '/nav/login' : '/login/logout'}">
					<img class="login_img" src="/resources/img/usertest.png" /> <span
					th:text="${session.login == null ? 'LOGIN' : 'LOGOUT'}"></span>
				</a>
			</div>
			<br />
			<div>
				<a href="/nav/mypage"><img class="mypage_img"
					src="/resources/img/file.png" />MYPAGE</a>
			</div>
		</div>
		<div class="search-container">
			<span class="search-icon"><img src="/resources/img/search.png"
				class="search-icon" /></span> <input type="text" class="search-input"
				placeholder="키워드 입력" />
		</div>
		<div>
			<a href="/nav/suggested">맞춤추천</a>
		</div>
		<div>
			<a href="/nav/chart">인기차트</a>
		</div>
		<div>
			<a href="/nav/community">커뮤니티</a>
		</div>
		<div>
			<a href="/nav/membership">멤버십</a>
		</div>
	</div>

	<div id="main">

		<div class="detail">
			<h1 class="detail-title" th:text="${community.boardTitle}"></h1>
			<div class="detail-btns">
				<button style="display: inline-block" id="update-btn" th:if="${session.login?.user_name == community.user_name}">
					<a
						th:href="@{/community/update/{boardNo}(boardNo=${community.boardNo})}">수정하기</a>
				</button>
				<button style="display: inline-block" id="delete-btn" type="submit"
					th:if="${community.user_name == session.login?.user_name}">
					<form
						th:action="@{/community/delete/{boardNo}(boardNo=${community.boardNo})}"
						method="post" id="delete-form">삭제하기</form>
				</button>
				<!-- 삭제 버튼은 글 작성자만 보이도록 해봄 나중에 수정할 수도 -->

				<button style="display: inline-block" id="write-btn">
					<a href="/community/write">글 작성</a>
				</button>
				<form
					th:action="@{/community/report/{boardNo}(boardNo=${community.boardNo})}"
					method="post" id="report-form">
					<button style="display: inline-block" id="report-btn" type="submit" data-board-no="${community.boardNo}">
						신고하기</button>
				</form>
			</div>

			<div class="detail-wrap">
				<div class="detail-name">
					<span>&nbsp;작성자 :</span><span th:text="${community.user_name}"></span>
				</div>
				<div class="detail-count">
					<span>&nbsp;조회수 :</span><span th:text="${community.boardViewCnt}"></span>
				</div>
				<div class="detail-content">
					<div class="content-box" type="text" id="content-input"
						th:text="${community.boardContent}"></div>
				</div>
			</div>


			<div class="comment-main">
				<div class="comment-detailfirst">

					<h2 class="comment-title">COMMENT</h2>
					<div class="comment-wrap">
						<div class="comment-item" th:each="comment : ${commentList}">
							<div class="comment-name">
								<span th:text="${comment.user_name}"></span>
							</div>
							<div class="comment-content">
								<span th:text="${comment.commentContent}"></span>
							</div>
							<!-- 댓글 옵션 버튼 및 목록 추가 -->
							<form
								th:action="@{/community/delete/comment/{commentNo}(commentNo=${comment.commentNo})}"
								method="post">
								<button type="submit" class="comment-dropdown"
									th:if="${comment.user_name == session.login?.user_name}">
									<img src="/resources/img/delete.png">
								</button>
							</form>
							<form
								th:action="@{/community/report/comment/{commentNo}(commentNo=${comment.commentNo})}"
								method="post" id="report-comment-form">
								<button type="submit" class="comment-dropdown" id="report-comment-btn" data-comment-no="${comment.commentNo}">
									<img src="/resources/img/report.png">
								</button>
							</form>
							
					
						</div>
					</div>


				</div>


				<div class="comment-detailsecond">
					<div class="comment-write">
						<form
							th:action="@{/community/comment/{boardNo}(boardNo=${community.boardNo})}"
							method="post">
							<textarea name="commentContent" rows="7" cols="75"
								placeholder="댓글을 입력해 주세요"></textarea>
					</div>
					<div class="comment-btn">
						<div id="commentwrite-btn">
							<input type="submit" value="작성 완료">
							</form>
						</div>
					</div>

				</div>
			</div>
		</div>
		<script>
		
			document.getElementById("delete-btn").addEventListener("click",
					function(event) {
						event.preventDefault(); // 폼 제출 이벤트 중지

						if (confirm("정말로 삭제하시겠습니까?")) {
							// 확인 버튼을 눌렀을 때 폼을 제출
							document.getElementById("delete-form").submit();
						}
					});	
		</script>
</body>

</html>